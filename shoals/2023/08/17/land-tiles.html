<!DOCTYPE html>
<html lang="en">
<!-- Beautiful Jekyll 6.0.1 | Copyright Dean Attali 2023 -->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  

  

  <title>Dryland XYZ tiles</title>

  
  <meta name="author" content="Bill Morris">
  

  <meta name="description" content="In which I discover how much geoprocessing you can get done with inline SQLite">

  

  
  <meta name="keywords" content="maps,history,travel,vermont">
  

  
  <link rel="alternate" type="application/rss+xml" title="Shoals" href="/shoals/feed.xml">
  

  

  

  

  


  
    
      
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">


    
      
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css">


    
      
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic">


    
      
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800">


    
  

  
    
      <link rel="stylesheet" href="/shoals/assets/css/bootstrap-social.css">
    
      <link rel="stylesheet" href="/shoals/assets/css/beautifuljekyll.css">
    
  

  

  
  
  

  

  
  <meta property="og:site_name" content="Shoals">
  <meta property="og:title" content="Dryland XYZ tiles">
  <meta property="og:description" content="In which I discover how much geoprocessing you can get done with inline SQLite">

  
  <meta property="og:image" content="/shoals/assets/img/2023-08-17_cover.png">
  

  
  <meta property="og:type" content="article">
  <meta property="og:article:author" content="Bill Morris">
  <meta property="og:article:published_time" content="2023-08-17T09:04:44-04:00">
  <meta property="og:url" content="/shoals/2023/08/17/land-tiles.html">
  <link rel="canonical" href="/shoals/2023/08/17/land-tiles.html">
  

  
  <meta name="twitter:card" content="summary_large_image">
  
  <meta name="twitter:site" content="@">
  <meta name="twitter:creator" content="@">

  <meta property="twitter:title" content="Dryland XYZ tiles">
  <meta property="twitter:description" content="In which I discover how much geoprocessing you can get done with inline SQLite">

  
  <meta name="twitter:image" content="/shoals/assets/img/2023-08-17_cover.png">
  

  


  

  

</head>


<body>

  


  <nav class="navbar navbar-expand-xl navbar-light fixed-top navbar-custom top-nav-regular"><a class="navbar-brand" href="/shoals">Shoals</a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="main-navbar">
    <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="https://billmorris.io">billmorris.io</a>
          </li>
        <li class="nav-item">
          <a class="nav-link" id="nav-search-link" href="#" title="Search">
            <span id="nav-search-icon" class="fa fa-search"></span>
            <span id="nav-search-text">Search</span>
          </a>
        </li></ul>
  </div>

  

  
    <div class="avatar-container">
      <div class="avatar-img-border">
        <a href="/shoals">
          <img alt="Navigation bar avatar" class="avatar-img" src="/shoals/assets/img/avatar-4.png" />
        </a>
      </div>
    </div>
  

</nav>



<div id="beautifuljekyll-search-overlay">

  <div id="nav-search-exit" title="Exit search">✕</div>
  <input type="text" id="nav-search-input" placeholder="Search">
  <ul id="search-results-container"></ul>
  
  <script src="https://unpkg.com/simple-jekyll-search@latest/dest/simple-jekyll-search.min.js"></script>
  <script>
    var searchjson = '[ \
       \
        { \
          "title"    : "Human stories in geologic time", \
          "category" : "storiesgeologyhistory", \
          "url"      : "/shoals/2023/09/24/stories-in-geologic-time.html", \
          "date"     : "September 24, 2023" \
        }, \
       \
        { \
          "title"    : "Perception and reality", \
          "category" : "equityequalitygenderrepresentationconferencetech", \
          "url"      : "/shoals/2023/09/21/perception-and-reality.html", \
          "date"     : "September 21, 2023" \
        }, \
       \
        { \
          "title"    : "Dryland XYZ tiles", \
          "category" : "sqlitemapsgdalpythonspatial analysis", \
          "url"      : "/shoals/2023/08/17/land-tiles.html", \
          "date"     : "August 17, 2023" \
        }, \
       \
        { \
          "title"    : "Tradewinds", \
          "category" : "mapschamplainclimate", \
          "url"      : "/shoals/2023/07/25/old-dock.html", \
          "date"     : "July 25, 2023" \
        }, \
       \
        { \
          "title"    : "A beautiful summer", \
          "category" : "vermontfloodclimate", \
          "url"      : "/shoals/2023/07/12/beautiful-summer.html", \
          "date"     : "July 12, 2023" \
        }, \
       \
        { \
          "title"    : "Once a cyclist", \
          "category" : "cyclingexerciseurban planningbike", \
          "url"      : "/shoals/2023/04/02/once-a-cyclist.html", \
          "date"     : "April  2, 2023" \
        }, \
       \
        { \
          "title"    : "A New Story", \
          "category" : "runningagingcycling", \
          "url"      : "/shoals/2023/03/10/a-new-story.html", \
          "date"     : "March 10, 2023" \
        }, \
       \
        { \
          "title"    : "Migrating with tusks and a trunk", \
          "category" : "twittermastodonsocial mediablog", \
          "url"      : "/shoals/2022/11/13/migrating.html", \
          "date"     : "November 13, 2022" \
        }, \
       \
        { \
          "title"    : "Adventures of a smartwatch in Paris [UPDATE: MYSTERY SOLVED]", \
          "category" : "gpsrunninggarmintravelparismaps", \
          "url"      : "/shoals/2022/10/10/watch-in-paris.html", \
          "date"     : "October 10, 2022" \
        }, \
       \
        { \
          "title"    : "A day on Hadrian&#39;s Wall", \
          "category" : "historytraveluk", \
          "url"      : "/shoals/2022/05/07/hadrian.html", \
          "date"     : "May  7, 2022" \
        }, \
       \
        { \
          "title"    : "The things he carried", \
          "category" : "stuffpersonal historybooksmaps", \
          "url"      : "/shoals/2022/03/09/grad-school-hoard.html", \
          "date"     : "March  9, 2022" \
        }, \
       \
        { \
          "title"    : "Compton", \
          "category" : "comptonsuperbowlpostgisfootballcartographymappinghiphopspatial analysis", \
          "url"      : "/shoals/2022/02/14/compton.html", \
          "date"     : "February 14, 2022" \
        }, \
       \
        { \
          "title"    : "How to deploy a webpage in 2022", \
          "category" : "webblogdns", \
          "url"      : "/shoals/2022/01/21/how-to-internet.html", \
          "date"     : "January 21, 2022" \
        }, \
       \
        { \
          "title"    : "2020 Census drop, yo.", \
          "category" : "censuspopulationvermontstatisticsmaps", \
          "url"      : "/shoals/2021/08/12/2020-census.html", \
          "date"     : "August 12, 2021" \
        }, \
       \
        { \
          "title"    : "Otto and Eugene", \
          "category" : "historyfascismnazisjan 6th", \
          "url"      : "/shoals/2021/01/10/otto-and-eugene.html", \
          "date"     : "January 10, 2021" \
        }, \
       \
        { \
          "title"    : "Democratizing data science where it counts", \
          "category" : "data scienceexcelsqlbigquerygoogle", \
          "url"      : "/shoals/2020/07/14/sql.html", \
          "date"     : "July 14, 2020" \
        }, \
       \
        { \
          "title"    : "Family artifacts", \
          "category" : "familyhistorypersonal historywwiichanel", \
          "url"      : "/shoals/2020/03/09/chanel-number-5.html", \
          "date"     : "March  9, 2020" \
        }, \
       \
        { \
          "title"    : "How I use Twitter in 2019", \
          "category" : "twitterblogculture", \
          "url"      : "/shoals/2019/11/11/twitter-in-2019.html", \
          "date"     : "November 11, 2019" \
        }, \
       \
        { \
          "title"    : "A full-throated defense of using Zipcodes for spatial analysis", \
          "category" : "spatial analysiszipcodesdata sciencemapping", \
          "url"      : "/shoals/2019/08/28/zipcodes-for-spatial-analysis.html", \
          "date"     : "August 28, 2019" \
        }, \
       \
        { \
          "title"    : "Following a phone case", \
          "category" : "techmanufacturingchinagooglegifs", \
          "url"      : "/shoals/2018/11/19/a-journey.html", \
          "date"     : "November 19, 2018" \
        }, \
       \
        { \
          "title"    : "All the Takes You’re About to See on the NYC-Snapchat Map Vandalism", \
          "category" : "osmmapsvandalism", \
          "url"      : "/shoals/2018/08/30/all-the-takes-youre-about-to-see-on-the-nycsnapchat-map-vandalism.html", \
          "date"     : "August 30, 2018" \
        }, \
       \
        { \
          "title"    : "A true map", \
          "category" : "mapshistorypoliticsculture", \
          "url"      : "/shoals/2018/07/28/true-map.html", \
          "date"     : "July 28, 2018" \
        }, \
       \
        { \
          "title"    : "New Belgium, 1650", \
          "category" : "mapshistoryvermont", \
          "url"      : "/shoals/2018/07/10/new-belgium.html", \
          "date"     : "July 10, 2018" \
        }, \
       \
        { \
          "title"    : "Imagination vs. the Moat", \
          "category" : "mappinggoogleappleosm", \
          "url"      : "/shoals/2017/12/20/imagination-vs-the-moat.html", \
          "date"     : "December 20, 2017" \
        }, \
       \
        { \
          "title"    : "Bonten Poad", \
          "category" : "llmmlaivermont", \
          "url"      : "/shoals/2017/07/20/bonten-poad-generating-fake-vermont-placenames-with-a-neural-network.html", \
          "date"     : "July 20, 2017" \
        }, \
       \
        { \
          "title"    : "Watching the Desert Bloom", \
          "category" : "satelliteslandsatgooglesaharaagriculture", \
          "url"      : "/shoals/2016/12/08/watching-the-desert-bloom.html", \
          "date"     : "December  8, 2016" \
        }, \
       \
        { \
          "title"    : "Drawing the planet in brushstrokes", \
          "category" : "satelliteartplanetaimlmapping", \
          "url"      : "/shoals/2016/11/11/drawing-the-planet-in-brushstrokes.html", \
          "date"     : "November 11, 2016" \
        }, \
       \
        { \
          "title"    : "Putting the Clinton campaign on the map", \
          "category" : "politicsmapping", \
          "url"      : "/shoals/2016/10/25/putting-the-clinton-campaign-on-the-map.html", \
          "date"     : "October 25, 2016" \
        }, \
       \
        { \
          "title"    : "Superblocks for a small city", \
          "category" : "urban planningmappingcitiesvermontburlington", \
          "url"      : "/shoals/2016/08/11/superblocks-for-a-small-city.html", \
          "date"     : "August 11, 2016" \
        }, \
       \
        { \
          "title"    : "From Above", \
          "category" : "culturesatelliteclimatepoliticsforests", \
          "url"      : "/shoals/2016/04/01/from-above.html", \
          "date"     : "April  1, 2016" \
        }, \
       \
        { \
          "title"    : "Primary 2016 Manifesto", \
          "category" : "politics", \
          "url"      : "/shoals/2016/02/04/primary-2016-manifesto.html", \
          "date"     : "February  4, 2016" \
        }, \
       \
        { \
          "title"    : "Better friendships through mapping technology", \
          "category" : "mappingtravel", \
          "url"      : "/shoals/2015/12/11/better-friendships-through-mapping-technology.html", \
          "date"     : "December 11, 2015" \
        }, \
       \
        { \
          "title"    : "Social Silos", \
          "category" : "", \
          "url"      : "/shoals/2015/11/03/social-silos.html", \
          "date"     : "November  3, 2015" \
        }, \
       \
        { \
          "title"    : "The cartographer’s promised land", \
          "category" : "mapping", \
          "url"      : "/shoals/2015/09/17/cartographers-promised-land.html", \
          "date"     : "September 17, 2015" \
        }, \
       \
        { \
          "title"    : "Caught in the Cartographic Crossfire", \
          "category" : "mappingmapspolitics", \
          "url"      : "/shoals/2015/04/24/caught-in-the-cartographic-crossfire.html", \
          "date"     : "April 24, 2015" \
        }, \
       \
        { \
          "title"    : "GeoASCII", \
          "category" : "mapping", \
          "url"      : "/shoals/2015/03/10/geoascii.html", \
          "date"     : "March 10, 2015" \
        }, \
       \
        { \
          "title"    : "This is not a post about Ello", \
          "category" : "", \
          "url"      : "/shoals/2014/12/01/this-is-not-a-post-about-ello.html", \
          "date"     : "December  1, 2014" \
        }, \
       \
        { \
          "title"    : "Redistricting: A Question and a Query", \
          "category" : "politicsmappingvermontburlington", \
          "url"      : "/shoals/2014/11/14/redistricting-a-question-and-a-query.html", \
          "date"     : "November 14, 2014" \
        }, \
       \
        { \
          "title"    : "Palm board and parchment", \
          "category" : "personal historymapping", \
          "url"      : "/shoals/2014/11/14/palm-board-and-parchment.html", \
          "date"     : "November 14, 2014" \
        }, \
       \
        { \
          "title"    : "Separation of Concerns", \
          "category" : "mapping", \
          "url"      : "/shoals/2014/08/24/separation-of-concerns.html", \
          "date"     : "August 24, 2014" \
        }, \
       \
        { \
          "title"    : "Constellations of Potential", \
          "category" : "googlemappinggps", \
          "url"      : "/shoals/2014/06/02/constellations-of-potential.html", \
          "date"     : "June  2, 2014" \
        }, \
       \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/shoals/404.html", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Shoals", \
          "category" : "page", \
          "url"      : "/shoals/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Tag Index", \
          "category" : "page", \
          "url"      : "/shoals/tags.html", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Shoals", \
          "category" : "page", \
          "url"      : "/shoals/page2/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Shoals", \
          "category" : "page", \
          "url"      : "/shoals/page3/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Shoals", \
          "category" : "page", \
          "url"      : "/shoals/page4/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Shoals", \
          "category" : "page", \
          "url"      : "/shoals/page5/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Shoals", \
          "category" : "page", \
          "url"      : "/shoals/page6/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Shoals", \
          "category" : "page", \
          "url"      : "/shoals/page7/", \
          "date"     : "January 1, 1970" \
        } \
       \
    ]';
    searchjson = JSON.parse(searchjson);

    var sjs = SimpleJekyllSearch({
      searchInput: document.getElementById('nav-search-input'),
      resultsContainer: document.getElementById('search-results-container'),
      json: searchjson
    });
  </script>
</div>





  <!-- TODO this file has become a mess, refactor it -->






  <div id="header-big-imgs" data-num-img=1
    
    
    
      
      data-img-src-1="/shoals/assets/img/2023-08-17_cover.png"
    
    
    
  ></div>


<header class="header-section has-img">

<div class="big-img intro-header">
  <div class="container-md">
    <div class="row">
      <div class="col-xl-8 offset-xl-2 col-lg-10 offset-lg-1">
        <div class="post-heading">
          <h1>Dryland XYZ tiles</h1>
          
            
              <h2 class="post-subheading">In which I discover how much geoprocessing you can get done with inline SQLite</h2>
            
          

          
            <span class="post-meta">Posted on August 17, 2023</span>
            
            
          
        </div>
      </div>
    </div>
  </div>
  <span class='img-desc'></span>
</div>

<div class="intro-header no-img">
  <div class="container-md">
    <div class="row">
      <div class="col-xl-8 offset-xl-2 col-lg-10 offset-lg-1">
        <div class="post-heading">
          <h1>Dryland XYZ tiles</h1>
          
            
              <h2 class="post-subheading">In which I discover how much geoprocessing you can get done with inline SQLite</h2>
            
          

          
            <span class="post-meta">Posted on August 17, 2023</span>
            
            
          
        </div>
      </div>
    </div>
  </div>
</div>
</header>





<div class=" container-md ">
  <div class="row">
    <div class=" col-xl-8 offset-xl-2 col-lg-10 offset-lg-1 ">

      

      

      <article role="main" class="blog-post">
        <p>Mapbox is occasionally referred to - not uncharitably - as “The Tile Company”. It’s true; we deal with big amounts of data, and the most common map/reduce unit we use is the <a href="https://en.wikipedia.org/wiki/Tiled_web_map">old standby Mercator/XYZ tile</a>. My past and present colleagues have built some really cool tools to make these patterns easier - witness <a href="https://github.com/mapbox/mercantile">mercantile</a> and <a href="https://github.com/mapbox/supermercado">supermercado</a>, for example - but sometimes there’s a specific problem to solve ad-hoc. In this case:</p>

<blockquote>
  <p>How can I get the geometry of every map tile at a given zoom level <strong>that intersects land?</strong></p>
</blockquote>

<p>There’s a whole lotta water out there, and as much as I’d like the odd view of shipping lanes, we do not render imagery beyond a few kilometers past the world’s coastlines. I need to knock something together to find the tiles of dry land.</p>

<h2 id="the-solution">The solution</h2>

<p>The answer is open data. (It’s always open data.) Specifically the <a href="https://www.naturalearthdata.com/">Natural Earth project</a>, which provides “land” polygons, in addition to all sorts of other goodies.</p>

<p>On top of that, we’ll use one of the tile utilities mentioned above - mercantile - plus <a href="https://gdal.org/programs/ogr2ogr.html">ogr2ogr</a>, the general-purpose Swiss army knife of geodata.</p>

<h3 id="set-some-parameters">Set some parameters</h3>
<p>We’ll want to define global variables for two things: desired tile size (set as metatile zoom level), and bounding box (the whole world in this case):</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">ZOOM</span><span class="o">=</span>5
<span class="nv">BBOX</span><span class="o">=</span><span class="s2">"[-180,-90,180,90]"</span>
</code></pre></div></div>

<h3 id="generate-global-tiles">Generate global tiles</h3>
<p><a href="https://github.com/mapbox/mercantile">Mercantile</a> is a python-based command line tool that can generate tile addresses and geometries. We’ll chain a few things together here to generate line-delimited GeoJSON of every tile in the world at zoom 5:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="k">${</span><span class="nv">BBOX</span><span class="k">}</span> | <span class="se">\</span>
    mercantile tiles <span class="k">${</span><span class="nv">ZOOM</span><span class="k">}</span> | <span class="se">\</span>
    mercantile shapes <span class="o">&gt;</span> <span class="se">\</span>
    z<span class="k">${</span><span class="nv">ZOOM</span><span class="k">}</span>_metatiles.geojsonl
</code></pre></div></div>

<p><img src="/shoals/assets/img/2023-08-17_1.png" alt="1" /></p>

<h3 id="download-the-land-data">Download the land data</h3>
<p>We’ll grab country polygons, and decompress them:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl https://www.naturalearthdata.com/http//www.naturalearthdata.com/download/10m/cultural/ne_10m_admin_0_countries.zip
unzip ne_10m_admin_0_countries.zip
</code></pre></div></div>

<p><img src="/shoals/assets/img/2023-08-17_2.png" alt="2" /></p>

<h3 id="combine-the-two">Combine the two</h3>
<p>This is the really facinating bit. I’m accustomed to using <a href="https://postgis.net/">PostGIS</a> for all my spatial SQL needs, but I’m getting more and more fond of the capabilities of SpatiaLite, which is a spatial function module for SQLite. And guess what you can use right out of the box with the aforementioned <code class="language-plaintext highlighter-rouge">ogr2ogr</code> toolset? Yep; SQLite. There’s actually quite a bit you can shoehorn into the inline <code class="language-plaintext highlighter-rouge">-sql</code> argument:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ogr2ogr <span class="se">\</span>
    <span class="nt">-f</span> GeoJSON <span class="se">\</span>
    z<span class="k">${</span><span class="nv">ZOOM</span><span class="k">}</span>_land_metatiles.geojson <span class="se">\</span>
    z<span class="k">${</span><span class="nv">ZOOM</span><span class="k">}</span>_metatiles.geojsonl <span class="se">\</span>
    <span class="nt">-dialect</span> sqlite <span class="se">\</span>
    <span class="nt">-sql</span> <span class="s2">"
        SELECT 
            m.id,
            REPLACE(REPLACE(REPLACE(m.id,', ','-'),'(',''),')','') AS layer,
            m.Geometry,
            GROUP_CONCAT(c.Name) AS countries
        FROM 'z</span><span class="k">${</span><span class="nv">ZOOM</span><span class="k">}</span><span class="s2">_metatiles.geojsonl'.z</span><span class="k">${</span><span class="nv">ZOOM</span><span class="k">}</span><span class="s2">_metatiles m
        JOIN 'ne_10m_admin_0_countries.shp'.ne_10m_admin_0_countries c 
            ON ST_Intersects(m.Geometry, c.Geometry)
        WHERE c.Name NOT IN ('Antarctica')
        GROUP BY m.id,m.Geometry
    "</span>
</code></pre></div></div>

<p>Catch all that? In the query above, we do a spatial INNER join between the countries and the tiles, keeping the geometries of the tiles that intersect any countries. Then we reformat the XYZ order of the tile ID to be a bit more friendly, and tack on a list of every intersecting country in a given tile. To top it off, we can exclude Antarctica (or any other named country polygon).</p>

<p>. . . and there’s what we were looking for in the first place! GeoJSON of all the Z5 tiles that intersect land!</p>

<p><img src="/shoals/assets/img/2023-08-17_3.png" alt="3" /></p>

<h3 id="the-wrap">The wrap</h3>
<p>Here’s <a href="https://gist.github.com/wboykinm/4550c13c30baee99febc6f02028b0ec6">the whole script</a>, executable like so if you want all the tiles intersecting land at zoom level 5:</p>

<p><code class="language-plaintext highlighter-rouge">bash land_tiles.sh 5</code></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># BUILD A DATASET OF TILES AT A GIVEN ZOOM LEVEL THAT INTERSECT LAND</span>
<span class="c"># USAGE: bash land_tiles.sh &lt;integer zoom level between 0 and 22&gt;</span>

<span class="c"># Set target metatile zoom</span>
<span class="nv">ZOOM</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">BBOX</span><span class="o">=</span><span class="s2">"[-180,-90,180,90]"</span>

<span class="c"># Create metatiles at desired zoom</span>
<span class="nb">echo</span> <span class="k">${</span><span class="nv">BBOX</span><span class="k">}</span> | <span class="se">\</span>
    mercantile tiles <span class="k">${</span><span class="nv">ZOOM</span><span class="k">}</span> | <span class="se">\</span>
    mercantile shapes <span class="o">&gt;</span> <span class="se">\</span>
    z<span class="k">${</span><span class="nv">ZOOM</span><span class="k">}</span>_metatiles.geojsonl

<span class="c"># Get Natural Earth countries</span>
curl <span class="nt">-O</span> https://naciscdn.org/naturalearth/10m/cultural/ne_10m_admin_0_countries.zip
unzip ne_10m_admin_0_countries.zip

<span class="c"># Join countries and metatiles</span>
ogr2ogr <span class="se">\</span>
    <span class="nt">-f</span> GeoJSON <span class="se">\</span>
    z<span class="k">${</span><span class="nv">ZOOM</span><span class="k">}</span>_land_metatiles.geojson <span class="se">\</span>
    z<span class="k">${</span><span class="nv">ZOOM</span><span class="k">}</span>_metatiles.geojsonl <span class="se">\</span>
    <span class="nt">-dialect</span> sqlite <span class="se">\</span>
    <span class="nt">-sql</span> <span class="s2">"
        SELECT 
            m.id,
            REPLACE(REPLACE(REPLACE(m.id,', ','-'),'(',''),')','') AS layer,
            m.Geometry,
            GROUP_CONCAT(c.Name) AS countries
        FROM 'z</span><span class="k">${</span><span class="nv">ZOOM</span><span class="k">}</span><span class="s2">_metatiles.geojsonl'.z</span><span class="k">${</span><span class="nv">ZOOM</span><span class="k">}</span><span class="s2">_metatiles m
        JOIN 'ne_10m_admin_0_countries.shp'.ne_10m_admin_0_countries c 
            ON ST_Intersects(m.Geometry, c.Geometry)
        WHERE c.Name NOT IN ('Antarctica')
        GROUP BY m.id,m.Geometry
    "</span>

<span class="c"># Clean up</span>
<span class="nb">rm</span> <span class="nt">-rf</span> ne_10m_admin_0_countries.<span class="k">*</span> z<span class="k">${</span><span class="nv">ZOOM</span><span class="k">}</span>_metatiles.geojsonl
</code></pre></div></div>

<p>All visualizations here were done with <a href="https://geojson.io/">geojson.io</a>.</p>

      </article>

      
        <div class="blog-tags">
          <span>Tags:</span>
          
            <a href="/shoals/tags#sqlite">sqlite</a>
          
            <a href="/shoals/tags#maps">maps</a>
          
            <a href="/shoals/tags#gdal">gdal</a>
          
            <a href="/shoals/tags#python">python</a>
          
            <a href="/shoals/tags#spatial analysis">spatial analysis</a>
          
        </div>
      

      

      
        <!-- Check if any share-links are active -->





      

      <ul class="pagination blog-pager">
        
        <li class="page-item previous">
          <a class="page-link" href="/shoals/2023/07/25/old-dock.html" data-toggle="tooltip" data-placement="top" title="Tradewinds">&larr; Previous Post</a>
        </li>
        
        
        <li class="page-item next">
          <a class="page-link" href="/shoals/2023/09/21/perception-and-reality.html" data-toggle="tooltip" data-placement="top" title="Perception and reality">Next Post &rarr;</a>
        </li>
        
      </ul>
      
  
  
  

  


  

  



    </div>
  </div>
</div>


  <footer>
  <div class="container-md beautiful-jekyll-footer">
    <div class="row">
      <div class="col-xl-8 offset-xl-2 col-lg-10 offset-lg-1">
      <ul class="list-inline text-center footer-links"><li class="list-inline-item">
    <a href="/shoals/feed.xml" title="RSS">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">RSS</span>
    </a>
  </li><li class="list-inline-item">
    <a href="mailto:bill@billmorris.io" title="Email me">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">Email me</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://github.com/wboykinm" title="GitHub">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-github fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">GitHub</span>
   </a>
  </li><li class="list-inline-item">
    <a rel="me" href="https://vis.social/@bil" title="Mastodon">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-mastodon fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">Mastodon</span>
    </a>
  </li></ul>

      
      <p class="copyright text-muted">
      
        Bill Morris
        &nbsp;&bull;&nbsp;
      
      2023

      

      

      

      </p>
      <p class="theme-by text-muted">
        Powered by
        <a href="https://beautifuljekyll.com">Beautiful Jekyll</a>
      </p>
      </div>
    </div>
  </div>
</footer>


  
  
    
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha256-4+XzXVhsDmqanXGHaHvgh1gMQKX40OUvDEBTu8JcmNs=" crossorigin="anonymous"></script>


  
    
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>


  
    
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>


  



  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
      <script src="/shoals/assets/js/beautifuljekyll.js"></script>
    
  









</body>
</html>
