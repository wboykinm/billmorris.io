<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Land ho! :: Shoals</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="In which I discover how much geoprocessing you can get done with inline SQLite" />
<meta name="keywords" content="SQLite, mapping, GDAL, python" />
<meta name="robots" content="noodp" />

<link rel="canonical" href="/shoals/posts/2023-08-17_land-tiles/" />






  
  
  
  
  
  <link rel="stylesheet" href="/shoals/styles.css">







  <link rel="shortcut icon" href="/shoals/img/theme-colors/blue.png">
  <link rel="apple-touch-icon" href="/shoals/img/theme-colors/blue.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Land ho!">
<meta property="og:description" content="In which I discover how much geoprocessing you can get done with inline SQLite" />
<meta property="og:url" content="/shoals/posts/2023-08-17_land-tiles/" />
<meta property="og:site_name" content="Shoals" />

  
  
    
  
  <meta property="og:image" content="/shoals/posts/2023-08-17_land-tiles/images/cover.png">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2023-08-17 09:04:44 -0400 EDT" />












</head>
<body class="blue">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/shoals/">
  <div class="logo">
    Shoals - a blog by Bill Morris
  </div>
</a>

    </div>
    
    
  </div>
  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="/shoals/posts/2023-08-17_land-tiles/">Land ho!</a>
  </h1>
  <div class="post-meta">
    
      <time class="post-date">
        2023-08-17 ::
        
      </time>
    
    
      <span class="post-author">Bill Morris</span>
    
    
  </div>

  
  
  <img src="/shoals/posts/2023-08-17_land-tiles/images/cover.png"
    class="post-cover"
    alt="Land ho!"
    title="Cover Image" />


  

  <div class="post-content"><div>
        <h2 id="the-problem">The problem<a href="#the-problem" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Mapbox is occasionally referred to - not uncharitably - as &ldquo;The Tile Company&rdquo;. It&rsquo;s true; we deal with big amounts of data, and the most common map/reduce unit we use is the <a href="https://en.wikipedia.org/wiki/Tiled_web_map">old standby Mercator/XYZ tile</a>. My past and present colleagues have built some really cool tools to make these patterns easier - witness <a href="https://github.com/mapbox/mercantile">mercantile</a> and <a href="https://github.com/mapbox/supermercado">supermercado</a>, for example - but sometimes there&rsquo;s a specific problem to solve ad-hoc. In this case:</p>
<blockquote>
<p>How can I get the geometries of every map tile at a given zoom level <strong>that intersects land?</strong></p>
</blockquote>
<p>There&rsquo;s a whole lotta water out there, and as much as I&rsquo;d like the odd view of shipping lanes, we do not render imagery beyond a few kilometers past the world&rsquo;s coastlines. I need to knock something together to find the tiles of dry land.</p>
<h2 id="the-solution">The solution<a href="#the-solution" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>The answer is open data. (It&rsquo;s always open data.) Specifically the <a href="https://www.naturalearthdata.com/">Natural Earth project</a>, which provides &ldquo;land&rdquo; polygons, in addition to all sorts of other goodies.</p>
<p>On top of that, we&rsquo;ll use one of the tile utilities mentioned above - mercantile - plus <a href="https://gdal.org/programs/ogr2ogr.html">ogr2ogr</a>, the general-purpose Swiss army knife of geodata.</p>
<h3 id="set-some-parameters">Set some parameters<a href="#set-some-parameters" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>We&rsquo;ll want to define global variables for two things: desired tile size (set as metatile zoom level), and bounding box (the whole world in this case):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ZOOM<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>BBOX<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;[-180,-90,180,90]&#34;</span>
</span></span></code></pre></div><h3 id="generate-global-tiles">Generate global tiles<a href="#generate-global-tiles" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p><a href="https://github.com/mapbox/mercantile">Mercantile</a> is a python-based command line tool that can generate tile addresses and geometries. We&rsquo;ll chain a few things together here to generate line-delimited GeoJSON of every tile in the world at zoom 5:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>echo <span style="color:#e6db74">${</span>BBOX<span style="color:#e6db74">}</span> | <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    mercantile tiles <span style="color:#e6db74">${</span>ZOOM<span style="color:#e6db74">}</span> | <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    mercantile shapes &gt; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    z<span style="color:#e6db74">${</span>ZOOM<span style="color:#e6db74">}</span>_metatiles.geojsonl
</span></span></code></pre></div><p><img src="images/1.png" alt="1"></p>
<h3 id="download-the-land-data">Download the land data<a href="#download-the-land-data" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>We&rsquo;ll grab country polygons, and decompress them:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl https://www.naturalearthdata.com/http//www.naturalearthdata.com/download/10m/cultural/ne_10m_admin_0_countries.zip
</span></span><span style="display:flex;"><span>unzip ne_10m_admin_0_countries.zip
</span></span></code></pre></div><p><img src="images/2.png" alt="2"></p>
<h3 id="combine-the-two">Combine the two<a href="#combine-the-two" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>This is the really facinating bit. I&rsquo;m accustomed to using <a href="https://postgis.net/">PostGIS</a> for all my spatial SQL needs, but I&rsquo;m getting more and more fond of the capabilities of SpatiaLite, which is a spatial function module for SQLite. And guess what you can use right out of the box with the aforementioned <code>ogr2ogr</code> toolset? Yep; SQLite. There&rsquo;s actually quite a bit you can shoehorn into the inline <code>-sql</code> argument:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ogr2ogr <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -f GeoJSON <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    z<span style="color:#e6db74">${</span>ZOOM<span style="color:#e6db74">}</span>_land_metatiles.geojson <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    z<span style="color:#e6db74">${</span>ZOOM<span style="color:#e6db74">}</span>_metatiles.geojsonl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -dialect sqlite <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -sql <span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        SELECT 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            m.id,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            REPLACE(REPLACE(REPLACE(m.id,&#39;, &#39;,&#39;-&#39;),&#39;(&#39;,&#39;&#39;),&#39;)&#39;,&#39;&#39;) AS layer,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            m.Geometry,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            GROUP_CONCAT(c.Name) AS countries
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        FROM &#39;z</span><span style="color:#e6db74">${</span>ZOOM<span style="color:#e6db74">}</span><span style="color:#e6db74">_metatiles.geojsonl&#39;.z</span><span style="color:#e6db74">${</span>ZOOM<span style="color:#e6db74">}</span><span style="color:#e6db74">_metatiles m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        JOIN &#39;ne_10m_admin_0_countries.shp&#39;.ne_10m_admin_0_countries c 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            ON ST_Intersects(m.Geometry, c.Geometry)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        WHERE c.Name NOT IN (&#39;Antarctica&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        GROUP BY m.id,m.Geometry
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;</span>
</span></span></code></pre></div><p>Catch all that? In the query above, we do a spatial INNER join between the countries and the tiles, keeping the geometries of the tiles that intersect any countries. Then we reformat the XYZ order of the tile ID to be a bit more friendly, and tack on a list of every intersecting country in a given tile. To top it off, we can exclude Antarctica (or any other named country polygon).</p>
<p>. . . and there&rsquo;s what we were looking for in the first place! GeoJSON of all the Z5 tiles that intersect land!</p>
<p><img src="images/3.png" alt="3"></p>
<h3 id="the-wrap">The wrap<a href="#the-wrap" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>Here&rsquo;s <a href="https://gist.github.com/wboykinm/4550c13c30baee99febc6f02028b0ec6">the whole script</a>, executable like so if you want all the tiles intersecting land at zoom level 5:</p>
<p><code>bash land_tiles.sh 5</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># BUILD A DATASET OF TILES AT A GIVEN ZOOM LEVEL THAT INTERSECT LAND</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># USAGE: bash land_tiles.sh &lt;integer zoom level between 0 and 22&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Set target metatile zoom</span>
</span></span><span style="display:flex;"><span>ZOOM<span style="color:#f92672">=</span>$1
</span></span><span style="display:flex;"><span>BBOX<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;[-180,-90,180,90]&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create metatiles at desired zoom</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">${</span>BBOX<span style="color:#e6db74">}</span> | <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    mercantile tiles <span style="color:#e6db74">${</span>ZOOM<span style="color:#e6db74">}</span> | <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    mercantile shapes &gt; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    z<span style="color:#e6db74">${</span>ZOOM<span style="color:#e6db74">}</span>_metatiles.geojsonl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Get Natural Earth countries</span>
</span></span><span style="display:flex;"><span>curl -O https://naciscdn.org/naturalearth/10m/cultural/ne_10m_admin_0_countries.zip
</span></span><span style="display:flex;"><span>unzip ne_10m_admin_0_countries.zip
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Join countries and metatiles</span>
</span></span><span style="display:flex;"><span>ogr2ogr <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -f GeoJSON <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    z<span style="color:#e6db74">${</span>ZOOM<span style="color:#e6db74">}</span>_land_metatiles.geojson <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    z<span style="color:#e6db74">${</span>ZOOM<span style="color:#e6db74">}</span>_metatiles.geojsonl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -dialect sqlite <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -sql <span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        SELECT 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            m.id,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            REPLACE(REPLACE(REPLACE(m.id,&#39;, &#39;,&#39;-&#39;),&#39;(&#39;,&#39;&#39;),&#39;)&#39;,&#39;&#39;) AS layer,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            m.Geometry,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            GROUP_CONCAT(c.Name) AS countries
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        FROM &#39;z</span><span style="color:#e6db74">${</span>ZOOM<span style="color:#e6db74">}</span><span style="color:#e6db74">_metatiles.geojsonl&#39;.z</span><span style="color:#e6db74">${</span>ZOOM<span style="color:#e6db74">}</span><span style="color:#e6db74">_metatiles m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        JOIN &#39;ne_10m_admin_0_countries.shp&#39;.ne_10m_admin_0_countries c 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            ON ST_Intersects(m.Geometry, c.Geometry)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        WHERE c.Name NOT IN (&#39;Antarctica&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        GROUP BY m.id,m.Geometry
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Clean up</span>
</span></span><span style="display:flex;"><span>rm -rf ne_10m_admin_0_countries.* z<span style="color:#e6db74">${</span>ZOOM<span style="color:#e6db74">}</span>_metatiles.geojsonl
</span></span></code></pre></div><p>All visualizations here were done with <a href="https://geojson.io/">geojson.io</a>.</p>

      </div></div>

  
    
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        
        <span class="button next">
            <a href="/shoals/posts/2023-07-25_old-dock/">
                <span class="button__text">Tradewinds</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2023 by <a href="https://billmorris.io">Bill Morris</a>, powered by <a href="http://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/shoals/bundle.min.js"></script>





  
</div>

</body>
</html>
